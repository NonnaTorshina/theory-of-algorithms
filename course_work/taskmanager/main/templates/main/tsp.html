{% extends 'main/base.html' %}

{% block title %}
Решение задачи
{% endblock %}

{% block content %}
<h1>Решение задачи коммивояжёра</h1>
<p class="lead">В окне ниже добавьте вершины графа кликом мыши и найдите оптимальный маршрут.</p>

<div class="row">
    <div class="col-md-8">
        <div class="card text-white k mb-4">
            <div class="card-header bg-light text-white">
                <h5 class="card-title mb-0">Поле для добавления вершин</h5>
            </div>
            <div class="card-body">
                <div class="alert bg-black text-white">
                    <strong>Инструкция:</strong> Кликайте мышкой на белом поле ниже, чтобы добавить вершины.
                    Для решения задачи нужно как минимум 3 вершины.
                </div>

                <div id="graphCanvasContainer" class="text-center">
                    <canvas id="graphCanvas" width="600" height="400"
                            style="border: 2px solid #dee2e6; cursor: crosshair; background-color: white; border-radius: 8px;">
                        Ваш браузер не поддерживает Canvas
                    </canvas>
                </div>

                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <div>
                        <button id="clearCanvas" class="btn btn-warning btn-sm me-2">
                            <i class="fas fa-trash"></i> Очистить поле
                        </button>
                        <button id="removeLastPoint" class="btn btn-secondary btn-sm">
                            <i class="fas fa-undo"></i> Удалить последнюю вершину
                        </button>
                    </div>
                    <span id="pointCount" class="badge bg-secondary fs-6">Вершин: 0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Правая колонка - настройки -->
    <div class="col-md-4">
        <div class="card text-dark">
            <div class="card-header bg-light text-white">
                <h5 class="card-title mb-0">Настройки алгоритма муравьиной колонии</h5>
            </div>
            <div class="card-body">
                <form id="tspForm" method="post">
                    {% csrf_token %}

                    <!-- Скрытое поле для координат вершин -->
                    <input type="hidden" id="verticesData" name="vertices" value="[]">

                    <div class="mb-3">
                        <label for="antCount" class="form-label">
                            <strong>Количество муравьев</strong>
                            <small class="text-muted">(1-1000)</small>
                        </label>
                        <input type="number" class="form-control" id="antCount" name="ant_count"
                               value="100" min="1" max="1000" required>
                        <div class="form-text">Больше муравьев - лучше поиск, но медленнее вычисления</div>
                    </div>

                    <div class="mb-3">
                        <label for="iterations" class="form-label">
                            <strong>Количество итераций</strong>
                            <small class="text-muted">(1-1000)</small>
                        </label>
                        <input type="number" class="form-control" id="iterations" name="iterations"
                               value="50" min="1" max="1000" required>
                        <div class="form-text">Больше итераций - лучше решение, но дольше расчет</div>
                    </div>

                    <div class="mb-3">
                        <label for="alpha" class="form-label">
                            <strong>Альфа (α)</strong>
                            <small class="text-muted">(0.1-5.0)</small>
                        </label>
                        <input type="number" step="0.1" class="form-control" id="alpha" name="alpha"
                               value="1.0" min="0.1" max="5.0" required>
                        <div class="form-text">Влияние феромонов на выбор пути</div>
                    </div>

                    <div class="mb-3">
                        <label for="beta" class="form-label">
                            <strong>Бета (β)</strong>
                            <small class="text-muted">(0.1-5.0)</small>
                        </label>
                        <input type="number" step="0.1" class="form-control" id="beta" name="beta"
                               value="2.0" min="0.1" max="5.0" required>
                        <div class="form-text">Влияние расстояния на выбор пути</div>
                    </div>

                    <div class="mb-3">
                        <label for="evaporation" class="form-label">
                            <strong>Испарение феромонов (ρ)</strong>
                            <small class="text-muted">(0.01-0.99)</small>
                        </label>
                        <input type="number" step="0.01" class="form-control" id="evaporation" name="evaporation"
                               value="0.5" min="0.01" max="0.99" required>
                        <div class="form-text">Коэффициент испарения феромонов</div>
                    </div>

                    <div class="mb-3">
                        <label for="q" class="form-label">
                            <strong>Q (количество феромонов)</strong>
                            <small class="text-muted">(1-1000)</small>
                        </label>
                        <input type="number" class="form-control" id="q" name="q"
                               value="100" min="1" max="1000" required>
                        <div class="form-text">Интенсивность отложения феромонов</div>
                    </div>

                    <button type="submit" class="btn btn-dark  w-100 py-2 fw-bold" id="solveBtn">
                        <i class="fas fa-play-circle"></i> Решить задачу коммивояжёра
                    </button>
                </form>
            </div>
        </div>

        <!-- Блок информации -->
        <div class="card text-dark mt-3">
            <div class="card-header bg-light text-white">
                <h6 class="card-title mb-0">Информация об алгоритме</h6>
            </div>
            <div class="card-body">
                <p class="small mb-2"><strong>Муравьиный алгоритм</strong> имитирует поведение муравьев,
                которые находят кратчайший путь к пище с помощью феромонов.</p>
                <p class="small mb-0">Каждый муравьй строит свой маршрут, а затем обновляет феромоны
                на пути в зависимости от его длины.</p>
            </div>
        </div>
    </div>
</div>

<!-- Результаты -->
{% if result %}
<div class="card text-dark mt-4">
    <div class="card-header {% if result.error %}bg-danger{% else %}bg-success{% endif %} text-white">
        <h5 class="card-title mb-0">
            {% if result.error %}
                <i class="fas fa-exclamation-triangle"></i> Ошибка выполнения
            {% else %}
                <i class="fas fa-check-circle"></i> Результат решения
            {% endif %}
        </h5>
    </div>
    <div class="card-body">
        {% if result.error %}
            <div class="alert alert-danger">
                <h6><i class="fas fa-bug"></i> Произошла ошибка:</h6>
                <p class="mb-0">{{ result.error }}</p>
            </div>
            <button class="btn btn-outline-primary" onclick="clearAndRetry()">
                <i class="fas fa-redo"></i> Попробовать снова
            </button>
        {% else %}
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <h6><i class="fas fa-route"></i> Оптимальный маршрут:</h6>
                        <div class="bg-light p-3 rounded">
                            <code class="fs-6">
                                {% for vertex in result.optimal_path %}
                                    {{ vertex }}{% if not forloop.last %} → {% endif %}
                                {% endfor %}
                            </code>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <h6><i class="fas fa-ruler"></i> Длина маршрута:</h6>
                            <p class="fs-4 fw-bold text-primary">{{ result.distance }}</p>
                        </div>
                        <div class="col-6">
                            <h6><i class="fas fa-clock"></i> Время выполнения:</h6>
                            <p class="fs-6">{{ result.execution_time }} сек</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <h6><i class="fas fa-bullseye"></i> Количество вершин:</h6>
                            <p class="fs-6">{{ result.vertices_count }}</p>
                        </div>
                        <div class="col-6">
                            <h6><i class="fas fa-redo"></i> Итерации алгоритма:</h6>
                            <p class="fs-6">{{ result.iterations }}</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <h6><i class="fas fa-chart-line"></i> График сходимости:</h6>
                    {% if result.convergence_chart %}
                        <img src="data:image/png;base64,{{ result.convergence_chart }}"
                             alt="График сходимости алгоритма" class="img-fluid rounded border">
                        <p class="small text-muted mt-1">График показывает изменение длины лучшего маршрута по итерациям</p>
                    {% else %}
                        <div class="alert alert-warning">
                            График сходимости недоступен
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Визуализация графа с решением -->
            <div class="mt-4">
                <h6><i class="fas fa-project-diagram"></i> Визуализация решения:</h6>
                <div class="text-center">
                    <canvas id="resultCanvas" width="600" height="400"
                            style="border: 2px solid #dee2e6; background-color: white; border-radius: 8px;">
                    </canvas>
                </div>
                <p class="small text-muted text-center mt-2">
                    Зеленые линии показывают оптимальный маршрут, красные точки - вершины графа
                </p>
            </div>

            <div class="mt-3 text-center">
                <button class="btn btn-outline-success me-2" onclick="saveCalculation()">
                    <i class="fas fa-save"></i> Сохранить расчет
                </button>
                <button class="btn btn-outline-primary" onclick="clearAndNew()">
                    <i class="fas fa-plus"></i> Новый расчет
                </button>
            </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- JavaScript для работы с canvas и взаимодействия -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');
        const verticesInput = document.getElementById('verticesData');
        const pointCountSpan = document.getElementById('pointCount');

        let vertices = [];
        let pointRadius = 8;
        const pointColor = '#495057';
        const pointBorderColor = '#212529';

        // Отрисовка точки с номером
        function drawPoint(x, y, index) {
            // Внешний круг (граница)
            ctx.fillStyle = pointBorderColor;
            ctx.beginPath();
            ctx.arc(x, y, pointRadius + 2, 0, 2 * Math.PI);
            ctx.fill();

            // Внутренний круг
            ctx.fillStyle = pointColor;
            ctx.beginPath();
            ctx.arc(x, y, pointRadius, 0, 2 * Math.PI);
            ctx.fill();

            // Номер точки
            ctx.fillStyle = 'white';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(index + 1, x, y);
        }

        // Отрисовка всех точек
        function redrawPoints() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            vertices.forEach((vertex, index) => {
                drawPoint(vertex.x, vertex.y, index);
            });
            updatePointCount();
        }

        // Обновление счетчика точек и скрытого поля
        function updatePointCount() {
            const count = vertices.length;
            pointCountSpan.textContent = `Вершин: ${count}`;
            verticesInput.value = JSON.stringify(vertices);

            // Изменяем цвет счетчика в зависимости от количества точек
            if (count < 3) {
                pointCountSpan.className = 'badge bg-warning fs-6';
            } else {
                pointCountSpan.className = 'badge bg-success fs-6';
            }
        }

        // Обработчик клика по canvas для добавления вершин
        canvas.addEventListener('click', function(event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;

            // Проверяем, не кликаем ли слишком близко к существующей точке
            const tooClose = vertices.some(vertex => {
                const distance = Math.sqrt((vertex.x - x) ** 2 + (vertex.y - y) ** 2);
                return distance < pointRadius * 3;
            });

            if (!tooClose) {
                vertices.push({x: Math.round(x), y: Math.round(y)});
                redrawPoints();

                // Анимация добавления
                canvas.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    canvas.style.transform = 'scale(1)';
                }, 150);
            } else {
                // Анимация запрета
                canvas.style.boxShadow = '0 0 10px red';
                setTimeout(() => {
                    canvas.style.boxShadow = 'none';
                }, 300);
            }
        });

        // Очистка canvas
        document.getElementById('clearCanvas').addEventListener('click', function() {
            if (vertices.length > 0) {
                if (confirm('Вы уверены, что хотите очистить все вершины?')) {
                    vertices = [];
                    redrawPoints();
                }
            }
        });

        // Удаление последней точки
        document.getElementById('removeLastPoint').addEventListener('click', function() {
            if (vertices.length > 0) {
                vertices.pop();
                redrawPoints();
            }
        });

        // Валидация формы перед отправкой
        document.getElementById('tspForm').addEventListener('submit', function(event) {
            if (vertices.length < 3) {
                event.preventDefault();
                showAlert('Для решения задачи нужно добавить как минимум 3 вершины!', 'warning');
                return;
            }

            // Показываем индикатор загрузки
            const solveBtn = document.getElementById('solveBtn');
            solveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Решаем задачу...';
            solveBtn.disabled = true;

            // Добавляем небольшую задержку для отображения спиннера
            setTimeout(() => {
                // Форма будет отправлена
            }, 100);
        });

        // Показ всплывающих сообщений
        function showAlert(message, type = 'info') {
            const alertClass = {
                'info': 'alert-info',
                'warning': 'alert-warning',
                'danger': 'alert-danger',
                'success': 'alert-success'
            }[type];

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.querySelector('.card-body').prepend(alertDiv);

            // Автоматическое скрытие через 5 секунд
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Если есть результат, отрисовываем граф с решением
        {% if result and not result.error %}
            drawSolution({{ result.optimal_path|safe }}, {{ result.vertices|safe }});
        {% endif %}

        // Функция отрисовки решения на отдельном canvas
        function drawSolution(path, vertices) {
            const resultCanvas = document.getElementById('resultCanvas');
            if (!resultCanvas) return;

            const resultCtx = resultCanvas.getContext('2d');

            // Очищаем canvas
            resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);

            // Рисуем ребра оптимального пути
            resultCtx.strokeStyle = '#28a745';
            resultCtx.lineWidth = 3;
            resultCtx.lineJoin = 'round';
            resultCtx.lineCap = 'round';

            for (let i = 0; i < path.length - 1; i++) {
                const currentIdx = path[i];
                const nextIdx = path[i + 1];

                if (currentIdx < vertices.length && nextIdx < vertices.length) {
                    const current = vertices[currentIdx];
                    const next = vertices[nextIdx];

                    resultCtx.beginPath();
                    resultCtx.moveTo(current[0], current[1]);
                    resultCtx.lineTo(next[0], next[1]);
                    resultCtx.stroke();
                }
            }

            // Рисуем точки
            vertices.forEach((vertex, index) => {
                const [x, y] = vertex;

                // Внешний круг
                resultCtx.fillStyle = '#dc3545';
                resultCtx.beginPath();
                resultCtx.arc(x, y, pointRadius + 2, 0, 2 * Math.PI);
                resultCtx.fill();

                // Внутренний круг
                resultCtx.fillStyle = '#ff6b6b';
                resultCtx.beginPath();
                resultCtx.arc(x, y, pointRadius, 0, 2 * Math.PI);
                resultCtx.fill();

                // Номер точки
                resultCtx.fillStyle = 'white';
                resultCtx.font = 'bold 12px Arial';
                resultCtx.textAlign = 'center';
                resultCtx.textBaseline = 'middle';
                resultCtx.fillText(index + 1, x, y);
            });
        }
    });

    // Вспомогательные функции
    function clearAndRetry() {
        window.location.reload();
    }

    function clearAndNew() {
        window.location.href = "{% url 'tsp-algorythm' %}";
    }

    function saveCalculation() {
        alert('Функция сохранения расчетов будет реализована в разделе "История расчетов"');
    }

    // Добавляем обработчик для подсказок
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (element) {
        new bootstrap.Tooltip(element);
    });
</script>

<!-- Добавляем иконки Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }

    .card-header {
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa !important;
        color: #212529 !important;
    }

    .btn {
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-1px);
    }

    #graphCanvas, #resultCanvas {
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #6c757d;
        box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
    }

    .alert {
        border: none;
        border-radius: 8px;
    }

    .badge {
        font-size: 0.9em !important;
    }
</style>
{% endblock %}